.data
fc1:
.byte 0x00
.byte 0x00
.byte 0x53
.byte 0x40
global_volume:
.byte 0x00
.byte 0x00
.byte 0x80
.byte 0x3f
end_fade:
.byte 0x00
.byte 0xfe
.byte 0x7f
.byte 0x3f
delay_dry:
.byte 0x00
.byte 0xcc
.byte 0xcc
.byte 0x3e
stereo_mod:
.byte 0x00
.byte 0x62
.byte 0x80
.byte 0x3f
main_tune:
.byte 0x00
.byte 0x65
.byte 0x42
.byte 0x39
oct_semitones:
.long 12
patterns:
.byte 14
.byte 193
.byte 0
.byte 57
.byte 0
.byte 0
.byte 55
.byte 0
.byte 0
.byte 0
.byte 0
.byte 50
.byte 0
.byte 0
.byte 48
.byte 0
.byte 0
.byte 0
.byte 0
.byte 50
.byte 0
.byte 0
.byte 57
.byte 0
.byte 17
.byte 0
.byte 0
.byte 58
.byte 0
.byte 0
.byte 57
.byte 0
.byte 0
.byte 0
.byte 0
.byte 53
.byte 197
.byte 0
.byte 60
.byte 0
.byte 0
.byte 0
.byte 0
.byte 57
.byte 0
.byte 0
.byte 55
.byte 0
.byte 22
.byte 186
.byte 0
.byte 53
.byte 0
.byte 0
.byte 50
.byte 0
.byte 0
.byte 0
.byte 0
.byte 46
.byte 0
.byte 0
.byte 57
.byte 57
.byte 17
.byte 0
.byte 0
.byte 50
.byte 0
.byte 0
.byte 46
.byte 0
.byte 19
.byte 0
.byte 0
.byte 53
.byte 188
.byte 0
.byte 50
.byte 0
.byte 0
.byte 0
.byte 0
.byte 46
.byte 0
.byte 0
.byte 55
.byte 0
.byte 0
.byte 0
.byte 0
.byte 50
.byte 0
.byte 0
.byte 46
.byte 0
.byte 14
.byte 197
.byte 0
.byte 57
.byte 190
.byte 0
.byte 55
.byte 0
.byte 0
.byte 0
.byte 0
.byte 50
.byte 0
.byte 0
.byte 48
.byte 181
.byte 21
.byte 0
.byte 0
.byte 50
.byte 16
.byte 0
.byte 57
.byte 178
.byte 17
.byte 0
.byte 0
.byte 58
.byte 193
.byte 0
.byte 57
.byte 176
.byte 0
.byte 200
.byte 0
.byte 53
.byte 0
.byte 0
.byte 60
.byte 173
.byte 0
.byte 0
.byte 0
.byte 57
.byte 0
.byte 0
.byte 55
.byte 0
.byte 22
.byte 0
.byte 193
.byte 53
.byte 198
.byte 0
.byte 50
.byte 178
.byte 0
.byte 0
.byte 0
.byte 46
.byte 0
.byte 0
.byte 57
.byte 178
.byte 0
.byte 0
.byte 0
.byte 50
.byte 0
.byte 41
.byte 46
.byte 0
.byte 15
.byte 43
.byte 183
.byte 53
.byte 191
.byte 0
.byte 50
.byte 0
.byte 0
.byte 0
.byte 0
.byte 46
.byte 0
.byte 0
.byte 55
.byte 0
.byte 0
.byte 0
.byte 0
.byte 50
.byte 0
.byte 0
.byte 46
.byte 0
.byte 14
.byte 190
.byte 0
.byte 57
.byte 193
.byte 0
.byte 55
.byte 0
.byte 0
.byte 0
.byte 0
.byte 50
.byte 0
.byte 0
.byte 48
.byte 188
.byte 21
.byte 0
.byte 0
.byte 50
.byte 16
.byte 0
.byte 57
.byte 185
.byte 17
.byte 191
.byte 193
.byte 58
.byte 200
.byte 0
.byte 57
.byte 181
.byte 0
.byte 0
.byte 0
.byte 53
.byte 0
.byte 0
.byte 60
.byte 176
.byte 0
.byte 0
.byte 0
.byte 57
.byte 0
.byte 0
.byte 55
.byte 0
.byte 22
.byte 186
.byte 193
.byte 53
.byte 0
.byte 0
.byte 50
.byte 178
.byte 0
.byte 55
.byte 0
.byte 46
.byte 0
.byte 0
.byte 57
.byte 57
.byte 17
.byte 0
.byte 0
.byte 50
.byte 0
.byte 50
.byte 46
.byte 0
.byte 19
.byte 193
.byte 183
.byte 53
.byte 0
.byte 0
.byte 50
.byte 0
.byte 195
.byte 0
.byte 0
.byte 46
.byte 0
.byte 0
.byte 55
.byte 0
.byte 31
.byte 0
.byte 0
.byte 50
.byte 0
.byte 0
.byte 46
.byte 0
.byte 14
.byte 193
.byte 0
.byte 57
.byte 202
.byte 0
.byte 190
.byte 55
.byte 0
.byte 0
.byte 0
.byte 50
.byte 0
.byte 50
.byte 48
.byte 190
.byte 21
.byte 0
.byte 0
.byte 50
.byte 16
.byte 48
.byte 57
.byte 188
.byte 17
.byte 0
.byte 193
.byte 58
.byte 197
.byte 0
.byte 57
.byte 185
.byte 0
.byte 200
.byte 53
.byte 183
.byte 29
.byte 0
.byte 60
.byte 185
.byte 0
.byte 0
.byte 0
.byte 57
.byte 17
.byte 0
.byte 55
.byte 0
.byte 19
.byte 195
.byte 57
.byte 183
.byte 190
.byte 50
.byte 55
.byte 178
.byte 0
.byte 0
.byte 202
.byte 50
.byte 0
.byte 0
.byte 48
.byte 0
.byte 7
.byte 0
.byte 0
.byte 50
.byte 0
.byte 43
.byte 55
.byte 178
.byte 12
.byte 41
.byte 53
.byte 181
.byte 205
.byte 188
.byte 193
.byte 52
.byte 0
.byte 0
.byte 48
.byte 0
.byte 0
.byte 1
.byte 43
.byte 183
.byte 24
.byte 0
.byte 0
.byte 48
.byte 12
.byte 0
.byte 55
.byte 0
.byte 19
.byte 195
.byte 67
.byte 185
.byte 198
.byte 0
.byte 62
.byte 186
.byte 0
.byte 0
.byte 55
.byte 183
.byte 0
.byte 0
.byte 38
.byte 0
.byte 0
.byte 0
.byte 31
.byte 0
.byte 0
.byte 0
.byte 31
.byte 178
.byte 14
.byte 0
.byte 67
.byte 181
.byte 193
.byte 0
.byte 62
.byte 0
.byte 0
.byte 0
.byte 50
.byte 0
.byte 0
.byte 0
.byte 45
.byte 0
.byte 0
.byte 195
.byte 38
.byte 0
.byte 0
.byte 0
.byte 26
.byte 0
.byte 12
.byte 0
.byte 60
.byte 0
.byte 176
.byte 0
.byte 48
.byte 183
.byte 0
.byte 0
.byte 43
.byte 181
.byte 0
.byte 0
.byte 36
.byte 180
.byte 0
.byte 0
.byte 24
.byte 0
.byte 0
.byte 0
.byte 24
.byte 176
.byte 24
.byte 0
.byte 60
.byte 171
.byte 0
.byte 0
.byte 48
.byte 0
.byte 0
.byte 188
.byte 43
.byte 0
.byte 0
.byte 0
.byte 36
.byte 169
.byte 0
.byte 0
.byte 24
.byte 168
.byte 0
.byte 0
.byte 24
.byte 164
.byte 19
.byte 198
.byte 12
.byte 166
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 202
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 205
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 19
.byte 7
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 14
.byte 190
.byte 0
.byte 57
.byte 193
.byte 0
.byte 55
.byte 0
.byte 0
.byte 0
.byte 0
.byte 50
.byte 0
.byte 0
.byte 48
.byte 0
.byte 0
.byte 0
.byte 0
.byte 50
.byte 0
.byte 0
.byte 57
.byte 0
.byte 17
.byte 0
.byte 0
.byte 58
.byte 0
.byte 0
.byte 57
.byte 0
.byte 0
.byte 0
.byte 0
.byte 53
.byte 197
.byte 0
.byte 60
.byte 0
.byte 0
.byte 0
.byte 0
.byte 57
.byte 0
.byte 0
.byte 55
.byte 0
.byte 22
.byte 186
.byte 0
.byte 53
.byte 0
.byte 0
.byte 50
.byte 0
.byte 0
.byte 0
.byte 0
.byte 46
.byte 0
.byte 0
.byte 57
.byte 57
.byte 17
.byte 0
.byte 0
.byte 50
.byte 0
.byte 0
.byte 46
.byte 0
.byte 19
.byte 193
.byte 0
.byte 53
.byte 188
.byte 0
.byte 50
.byte 0
.byte 0
.byte 0
.byte 0
.byte 46
.byte 0
.byte 0
.byte 55
.byte 0
.byte 0
.byte 0
.byte 0
.byte 50
.byte 0
.byte 0
.byte 46
.byte 0
order:
.byte 6
.byte 0
.byte 1
.byte 2
.byte 1
.byte 3
.byte 4
.byte 5
elements:
.byte 2
.byte 0
.byte 0
.byte 0
.byte 60
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 131
.byte 58
.byte 0
.byte 0
.byte 0
.byte 63
.byte 0
.byte 255
.byte 127
.byte 63
.byte 0
.byte 0
.byte 0
.byte 0
.byte 128
.byte 0
.byte 0
.byte 0
.byte 32
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 113
.byte 62
.byte 0
.byte 0
.byte 128
.byte 63
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 163
.byte 0
.byte 64
.byte 1
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 153
.byte 89
.byte 63
.byte 0
.byte 0
.byte 0
.byte 0
.byte 128
.byte 0
.byte 0
.byte 0
.byte 60
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 35
.byte 61
.byte 0
.byte 0
.byte 128
.byte 63
.byte 0
.byte 168
.byte 123
.byte 56
.byte 0
.byte 0
.byte 0
.byte 0
.byte 2
.byte 0
.byte 0
.byte 0
.byte 60
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 134
.byte 53
.byte 0
.byte 57
.byte 180
.byte 61
.byte 0
.byte 254
.byte 127
.byte 63
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 32
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 183
.byte 62
.byte 0
.byte 0
.byte 128
.byte 63
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 32
.byte 192
.byte 63
.byte 1
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 153
.byte 153
.byte 62
.byte 0
.byte 0
.byte 0
.byte 0
.byte 2
.byte 0
.byte 0
.byte 0
.byte 84
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 214
.byte 51
.byte 0
.byte 0
.byte 0
.byte 63
.byte 0
.byte 0
.byte 128
.byte 63
.byte 0
.byte 0
.byte 0
.byte 0
.byte 2
.byte 0
.byte 0
.byte 0
.byte 32
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 35
.byte 60
.byte 0
.byte 194
.byte 117
.byte 62
.byte 0
.byte 252
.byte 127
.byte 63
.byte 0
.byte 0
.byte 0
.byte 0
.byte 128
.byte 0
.byte 2
.byte 0
.byte 32
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 128
.byte 63
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 71
.byte 129
.byte 63
.byte 1
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 204
.byte 204
.byte 62
.byte 0
.byte 0
.byte 0
.byte 0
.byte 130
.byte 0
.byte 0
.byte 0
.byte 60
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 81
.byte 57
.byte 0
.byte 112
.byte 189
.byte 62
.byte 0
.byte 254
.byte 127
.byte 63
.byte 0
.byte 0
.byte 0
.byte 0
.byte 128
.byte 0
.byte 2
.byte 0
.byte 32
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 107
.byte 62
.byte 0
.byte 0
.byte 128
.byte 63
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 71
.byte 129
.byte 63
.byte 1
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 63
.byte 0
.byte 0
.byte 0
.byte 0
trigger_points:
.byte 0
.byte 0
.byte 0
.byte 0
.byte 96
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 0
.byte 96
.byte 0
.byte 0
.byte 0
.byte 192
.byte 0
.byte 0
.byte 0
.byte 96
.byte 0
.byte 0
.byte 0
.byte 192
.byte 0
.byte 0
.byte 0
.byte 8
.byte 1
.byte 0
.byte 0
.text
module_oscillator:
pusha
fld1
flds 16(%esi)
flds 12(%esi)
fadd %st(2)
fmulp
flds _ZL8g_buffer+8
fmulp
fxch %st(1)
flds 0(%ebp)
fadd %st(2),%st
fprem1
fstps 0(%ebp)
flds 20(%esi)
fmulp %st,%st(2)
flds 4(%ebp)
fadd %st(2),%st
fprem1
fsts 4(%ebp)
testl $0x20000,(%esi)
jz _osc_skip_square
fptan
fstp %st
_osc_skip_square:
flds 0(%ebp)
faddp
fxch %st(2)
fstp %st
fstp %st
fmuls 8(%esi)
popa
osc_end:
ret
module_filter:
pusha
flds 16(%esi)
flds 12(%esi)
fmuls fc1
fmulp
flds 0(%ebp)
flds 4(%ebp)
fsubrp 
fmulp
fsin
flds 8(%esi)
flds 12(%esi)
fabs
fmulp
flds 0(%ebp)
fld1
flds 12(%esi)
fabs
fsubrp %st(1)
fmulp
faddp
faddp
fsts 0(%ebp)
flds 12(%esi)
fabs
fadd %st
fld1
fsub %st(1),%st
fmuls 4(%ebp)
fxch %st(1)
fmul %st(2),%st
faddp
fsts 4(%ebp)
fxch %st(1)
fstp %st
filter_end:
popa
ret
small:
.byte 0
.byte 0
.byte 128
.byte 0
module_envelope:
pusha
flds 0(%ebp)
movl 20(%esi),%eax
testl %eax,%eax
jnz module_envelope.in_decay
flds 8(%esi)
faddp
flds 12(%esi)
fcomip
jnc module_envelope.no_switch
incl %eax
movl %eax,20(%esi)
module_envelope.no_switch:
jmp module_envelope.no_decay
module_envelope.in_decay:
flds 16(%esi)
cmpl $1,%eax
je module_envelope.no_release
fmul %st,%st(1)
fmul %st,%st(1)
fmul %st,%st(1)
module_envelope.no_release:
fmulp
module_envelope.no_decay:
flds small
faddp
fsts 0(%ebp)
envelope_end:
popa
ret
synth:
pusha
movl %eax,%edi
movl %edx,%ecx
pusha
leal _ZL8g_buffer+20,%edi
movl $4,%ecx
setup_loop:
pushl %ecx
leal elements,%esi
movl $6*4*14,%ecx
rep
movsb
popl %ecx
loop setup_loop
popa
xorl %edx,%edx
synth_loop:
pushl %ecx
cmpl $0x20000,%ecx
jns synth_loop.no_fade
flds global_volume
fmuls end_fade
fstps global_volume
synth_loop.no_fade:
fldz
leal _ZL8g_buffer+20,%esi
leal _ZL8g_buffer+1364,%ebp
movl $4,%ecx
tracks_loop:
pushl %ecx
testl %edx,%edx
jnz notick
movl _ZL8g_buffer+0,%ebx
movb order(%ebx),%bl
imull $96,%ebx
movl _ZL8g_buffer+4,%eax
addl %eax,%ebx
xorl %eax,%eax
movb patterns(%ebx),%al
cmpb $0,%al
je notrig
pusha
andb $0x7f,%al
movb $12,%bl
divb %bl
movb %ah,_ZL8g_buffer+16
fildl _ZL8g_buffer+16
fildl oct_semitones
fdivrp 
f2xm1
fld1
faddp
movl $1,%ebx
movb %al,%cl
shl %cl,%ebx
movl %ebx,_ZL8g_buffer+16
fildl _ZL8g_buffer+16
fmulp
flds main_tune
fmulp
popa
popl %ecx
pushl %ecx
pusha
negl %ecx
addl $4,%ecx
imull $8,%ecx
testb $0x80,%al
jz no_alt_instr
addl $4,%ecx
no_alt_instr:
addl $trigger_points, %ecx
movl (%ecx),%ecx
addl %ecx,%esi
cmpb $1,%al
je noteoff
movl $0,20(%esi)
fstps 6*4+16(%esi)
jmp no_noteoff
noteoff:
movl $2,20(%esi)
no_noteoff:
popa
notrig:
movl _ZL8g_buffer+4,%eax
incl %eax
cmpl $96,%eax
jne no_advance
movl _ZL8g_buffer+0,%eax
incl %eax
movl %eax,_ZL8g_buffer+0
xorl %eax,%eax
no_advance:
movl %eax,_ZL8g_buffer+4
notick:
movl $14,%ecx
element_loop:
pushl %ecx
movl (%esi),%eax
pushl %ebp
testl $0x4,%edi
fld1
jz element_loop.ch_left
testb $0x80,%al
jz element_loop.mono_only
flds stereo_mod
fmulp
element_loop.mono_only:
addl $4096*2,%ebp
element_loop.ch_left:
fstps _ZL8g_buffer+8
andb $0x7f,%al
cmpb $0x00,%al
jne no_osc
call module_oscillator
no_osc:
cmpb $0x01,%al
jne no_filter
call module_filter
no_filter:
cmpb $0x02,%al
jne no_envelope
call module_envelope
no_envelope:
movl 4(%esi),%ebx
testl %ebx,%ebx
jnz not_master_out
faddp
jmp was_master_out
not_master_out:
addl %esi,%ebx
cmpb $0,%ah
je no_op
flds (%ebx)
cmpb $1,%ah
jne no_op_add
op_add:
faddp
no_op_add:
no_op:
fstps (%ebx)
was_master_out:
addl $6*4,%esi
popl %ebp
addl $4096*2*2,%ebp
popl %ecx
decl %ecx
jnz element_loop
popl %ecx
decl %ecx
jnz tracks_loop
decl %edx
jns was_master_out.no_newtick
movl $40000,%edx
was_master_out.no_newtick:
fmuls global_volume
fstps (%edi)
addl $4,%edi
popl %ecx
decl %ecx
jnz synth_loop
popa
ret
